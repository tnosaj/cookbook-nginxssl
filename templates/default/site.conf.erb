<% ::Chef::Mixin::Template::TemplateContext.send(:include, Nginx::Ssl::StringHelper) %>
server {
  server_name     <%= parseOptions(@servername).map { |opt| opt }.join(" ") %>;
  access_log /var/log/nginx/access-<%= @name%>-.log;
  error_log /var/log/nginx/error-<%= @name%>-.log;
  <% parseOptions(@serveroptions).each do |opt| %>
  <%= opt %>;
  <% end %>


#### Enable to redirect all Traffic to SSL
  if ($http_host = "www.runtastic.com") {
      rewrite ^/(.*)$ https://www.runtastic.com/$1;
  }

  if ($http_host = "runtastic.com") {
      rewrite ^/(.*)$ https://www.runtastic.com/$1;
  }

  if ($http_host = "maps.runtastic.com") {
      rewrite ^/(.*)$ http://www.runtastic.com/$1;
  }

  location ^~ /shop/ {
    rewrite ^ https://www.runtastic.com$request_uri? permanent;
  }

#+++++++++++++++
#++ Modifiers ++
#+++++++++++++++
  <% @modifiers.each do |modname,mod| %>
  # <%= modname %>
  if (<%= mod['query'] %>){
  <% parseOptions(mod['options']).each do |opt| %>
    <%= opt %>;
  <% end %>
  }
  <% end %>

#+++++++++++++++
#++ Locations ++
#+++++++++++++++
  <% @locations.each do |locname,loc| %>
  # <%= locname %>
  location <%= loc['base'] %> {
  <% parseOptions(loc['options']).each do |opt| %>
    <%= opt %>;
  <% end %>
  }

  <% end %>

}
