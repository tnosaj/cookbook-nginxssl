<% ::Chef::Mixin::Template::TemplateContext.send(:include, Rtnginx::Ssl::StringHelper) %>
server {
  server_name     <%= parseOptions(@servername).map { |opt| opt }.join(" ") %>;
  access_log /var/log/nginx/access-<%= @name%>-.log;
  error_log /var/log/nginx/error-<%= @name%>-.log;
  <% parseOptions(@serveroptions).each do |opt| %>
  <%= opt %>;
  <% end %>


#### Enable to redirect all Traffic to SSL
  if ($http_host = "www.runtastic.com") {
      rewrite ^/(.*)$ https://www.runtastic.com/$1;
  }

  if ($http_host = "runtastic.com") {
      rewrite ^/(.*)$ https://www.runtastic.com/$1;
  }

#+++++++++++++++
#++ Redirects ++
#+++++++++++++++

  if ($http_host = "maps.runtastic.com") {
      rewrite ^/(.*)$ http://www.runtastic.com/$1;
  }

  <% @locations.sort.each do |locname,loc| %>
  # <%= locname %>
  location <%= loc['base'] %> {
  <% parseOptions(loc['options']).each do |opt| %>
    <%= opt %>;
  <% end %>
  }
  <% end %>


  location ^~ /shop/ {
    rewrite ^ https://www.runtastic.com$request_uri? permanent;
  }

  location / {
    proxy_pass ;
    proxy_set_header Host $host;
    proxy_set_header x-forwarded-for $remote_addr;
  }
}
