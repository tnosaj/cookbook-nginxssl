#
# Generated by Chef
#
worker_processes  <%= @workers %>;
events {
    worker_connections  1024;
}


http {
    passenger_root <%= @passenger_root %>;
    passenger_ruby <%= @passenger_ruby %>;

    include       mime.types;
    default_type  application/octet-stream;

    # count of simultaneous rails instances -> 30 recommended for dedicated server with 2gb ram, for virtual appliance with 256mb ram -> 2
    passenger_max_pool_size    <%= @poolsize %>;

    passenger_pool_idle_time     <%= @idletime %>; # set it to 30 minutes (1800 seconds) cause fresh instances are better than old ones - memory-reasons  (0 for no deactivation of instances) 

    # dont limit instances for app -> because we only have one
    passenger_max_instances_per_app 0;

    passenger_start_timeout 180;
    # span - codecaching  - smart, smart-lv2, conservative
    rails_spawn_method 'smart-lv2';

    log_format  main  '$http_x_forwarded_for - [$time_local] "$request" - "$http_user_agent" - $status';

    access_log  logs/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    ##################
    # GZIP-Filter
    ##################
    gzip  on;
    gzip_http_version 1.0;
    gzip_vary on;
    gzip_comp_level 6;
    gzip_proxied any;
    gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;
    # make sure gzip does not lose large gzipped js or css files
    # see http://blog.leetsoft.com/2007/7/25/nginx-gzip-ssl
    gzip_buffers 16 8k;
    ########################

    server {
        rails_env <%= node['nginx']['env'] %>;
        listen       <%= @port %>;
        server_name  <%= @servername %>;
        root <%= @nginx_root %>;
        passenger_enabled on;
        index index.html index.htm;
        client_max_body_size 50M;


        # disable access-logging for check.txt to that haproxy-alive-checks won't get logged every 2 seconds
        location = /check.txt {
          access_log off;
          expires 30d;
        }


        ###############################################
        # add max-age expires-header for images, etc.
        ###############################################
        location ~* \.(js)(\?[0-9]+)?$ {
            add_header Access-Control-Allow-Origin *;
        }
        location ~* \.(ico|css|js|gif|jpe?g|png|ico|gz)(\?[0-9]+)?$ {
            expires 30d;
            gzip_static on; # to serve pre-gzipped version
            add_header Cache-Control public;
            break;
        }

        rewrite "/rel-\w{40}/(.*)$" /$1 break;

        if (-f $document_root/system/maintenance.html) {
          rewrite ^(.*)$ /system/maintenance.html break;
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
}
